configfile: "config.json"

SAMPLES, = glob_wildcards(config['haplohiv_folder']+"ec/{id}.fastq")

rule all:
    input:  
        expand("{prefix}/mapped/{samples}.sam", prefix=config['output_dir'], samples=SAMPLES)        
#        expand("{prefix}/haplotypes/{samples}_haplotypes.fa", prefix=config['output_dir'], samples="SAMPLES")

rule map_to_consensus:
    input:
        reads = config['haplohiv_folder']+"ec/{samples}.fastq",
        consensus = config['output_dir']+"/consensus/masterconsensus_"+config['patient']+"_consensus.fa"
    output:
        config['output_dir']+"/mapped/{samples}.sam"
    shell:
        """
        bwa mem -p {input.consensus} {input.reads} > {output}
        """

rule configure_predicthaplo:
    input:
        dummy = "PredictHaplo_dummy.conf",
        sample = "{prefix}/mapped/{samples}.sam"
    output:
        "{prefix}/predicthaplo/{samples}.conf"
    shell:
        """
        cp {input.dummy} {output}
        sed -i "s|prefix_line|{config[output_dir]}/predicthaplo/output_{wildcards.samples}/{wildcards.samples}|" {output}
        name=`grep {wildcards.samples} {config[table]} | awk '{{print $3}}'`
        sed -i "s|reference_line|{config[output_dir]}/consensus/${{name::-1}}_consensus.fa|" {output}
        sed -i "s|reads_line|{input.sample}|" {output}
        """

rule predicthaplo:
    input:
        "{prefix}/predicthaplo/{samples}.conf"
    output:
        "{prefix}/predicthaplo/output_{samples}/{samples}.conf"
    shell:
        """
        PredictHaplo-Paired {input}
        mv {input} {output}
        """

rule gather_haplotype:
    input:
        "{prefix}/predicthaplo/output_{samples}/{samples}.conf"
    output:
        "{prefix}/haplotypes/{samples}_haplotypes.fa"
    shell:
        """
        mkdir -p {config[output_dir]}/haplotypes
        python scripts/gather_haplotypes.py {config[output_dir]}/predicthaplo/output_{wildcards.samples}/{wildcards.samples}global_*.fas \
        {output} {wildcards.samples}
        """
